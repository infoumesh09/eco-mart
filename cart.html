<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - Eco Mart</title>
    <link rel="stylesheet" href="styles/theme.css">
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .cart-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
        }

        .cart-item {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 1.5rem;
            align-items: center;
            padding: 1rem;
            margin-bottom: 1rem;
            background: var(--background-white);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .cart-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
        }

        .cart-item-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quantity-control input {
            width: 60px;
            text-align: center;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .cart-actions {
            display: flex;
            gap: 0.5rem;
        }

        .cart-summary {
            margin-top: 2rem;
            text-align: right;
        }

        .cart-total {
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        .empty-cart {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 2rem;
            background: var(--primary-color);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* User Dropdown Menu Styles */
        .user-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f0f0f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-dark, #333);
            min-width: 120px;
            justify-content: center;
        }

        .dropdown-button:hover {
            background-color: #e0e0e0;
        }

        .user-name {
            font-weight: 500;
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--primary-color, #2E7D32);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .dropdown-content {
            position: absolute;
            right: 0;
            top: 45px;
            background-color: white;
            min-width: 180px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            z-index: 1000;
            display: none;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-content a {
            color: var(--text-dark, #333);
            padding: 12px 16px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s;
        }

        .dropdown-content a:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>
    <!-- Include navigation -->
    <div id="nav-placeholder"></div>

    <main class="container">
        <div class="cart-container card">
            <h1>Your Shopping Cart</h1>
            <div id="cart-items">
                <!-- Loading spinner -->
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>

            <div class="cart-summary">
                <p class="cart-total">Total: â‚¹<span id="total-price">0</span></p>
                <div class="cart-actions">
                    <button class="btn btn-secondary" onclick="handleClearCart()">Clear Cart</button>
                    <button class="btn btn-primary" onclick="proceedToCheckout()">Proceed to Checkout</button>
                    <a href="shop.html" class="btn btn-secondary">Continue Shopping</a>
                    <button class="btn btn-secondary" onclick="debugCart()" style="margin-left: 10px;">Debug Cart</button>
                </div>
            </div>
        </div>
    </main>

    <footer class="main-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>About Eco Mart</h3>
                    <p>Your one-stop shop for sustainable and eco-friendly products.</p>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul class="footer-links">
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="contact.html">Contact</a></li>
                        <li><a href="shipping.html">Shipping Info</a></li>
                        <li><a href="returns.html">Returns</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contact Us</h3>
                    <ul class="footer-links">
                        <li>Email: support@ecomart.com</li>
                        <li>Phone: (555) 123-4567</li>
                        <li>Address: 123 Green Street</li>
                    </ul>
                </div>
            </div>
            <div style="text-align: center; margin-top: 2rem;">
                <p>&copy; 2024 Eco Mart. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Include cart.js with error handling -->
    <script>
        // Check if cart.js fails to load
        window.addEventListener('error', function(event) {
            if (event.target.tagName === 'SCRIPT' && event.target.src.includes('cart.js')) {
                console.error('Error loading cart.js, using fallback functions');
                // The fallback functions are already defined below
            }
        }, true);
    </script>
    <script src="scripts/cart.js"></script>
    <script>
        // Replace fetch navigation with direct HTML
        document.getElementById('nav-placeholder').innerHTML = `
            <header class="main-header">
                <nav class="main-nav container">
                    <a href="newhome.html" class="logo">
                        <img src="images/newlogo.png" alt="Eco Mart Logo" height="30">
                    </a>
                    <div class="nav-links">
                        <a href="newhome.html">Home</a>
                        <a href="shop.html">Shop</a>
                        <a href="category.html">Categories</a>
                        <a href="offers.html">Offers</a>
                        <a href="wishlist.html">Wishlist</a>
                        <a href="cart.html" class="active">Cart</a>
                    </div>
                    <div id="auth-section">
                        <!-- This will be updated by updateAuthSection function -->
                    </div>
                </nav>
            </header>
        `;

        // Function to update auth section based on login state
        function updateAuthSection() {
            const authSection = document.getElementById('auth-section');
            if (!authSection) return;
            
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (token) {
                // User is logged in
                const displayName = user.username || user.name || user.email || 'User';
                const userInitial = displayName.charAt(0).toUpperCase();
                
                // Create user dropdown for authenticated users
                authSection.innerHTML = `
                    <div class="user-dropdown">
                        <button class="dropdown-button">
                            <span class="user-name">${displayName}</span>
                            <div class="user-avatar">${userInitial}</div>
                        </button>
                        <div class="dropdown-content">
                            <a href="profile.html"><i class="fas fa-user"></i> Profile</a>
                            <a href="orders.html"><i class="fas fa-shopping-bag"></i> Orders</a>
                            <a href="cart.html"><i class="fas fa-shopping-cart"></i> Cart</a>
                            <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                        </div>
                    </div>
                `;
                
                // Add event listener to logout button
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        handleLogout();
                    });
                }
                
                // Add event listener to toggle dropdown
                const dropdownButton = authSection.querySelector('.dropdown-button');
                const dropdownContent = authSection.querySelector('.dropdown-content');
                
                if (dropdownButton && dropdownContent) {
                    dropdownButton.addEventListener('click', function(e) {
                        e.stopPropagation();
                        dropdownContent.classList.toggle('show');
                    });
                    
                    // Close dropdown when clicking outside
                    document.addEventListener('click', function(event) {
                        if (!event.target.closest('.user-dropdown')) {
                            dropdownContent.classList.remove('show');
                        }
                    });
                }
            } else {
                // User is not logged in
                authSection.innerHTML = `
                    <a href="login.html" class="btn btn-primary">Login</a>
                    <a href="register.html" class="btn btn-secondary">Register</a>
                `;
            }
        }

        // Function to handle logout
        function handleLogout() {
            // Backup wishlist items before logout if they exist
            const wishlistItems = localStorage.getItem('wishlistItems');
            if (wishlistItems) {
                console.log('Backing up wishlist items before logout');
                localStorage.setItem('wishlistItemsBackup', wishlistItems);
            }
            
            // Clear all user-related data
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            
            // Clear cart and wishlist data
            if (window.clearLocalCart) {
                window.clearLocalCart();
            } else {
                localStorage.removeItem('cartItems');
            }
            
            if (window.clearLocalWishlist) {
                window.clearLocalWishlist();
            } else {
                localStorage.removeItem('wishlistItems');
            }
            
            console.log('User logged out, cleared all local data');
            
            // Try to call API logout if available
            try {
                const API_URL = 'http://localhost:3000/api';
                fetch(`${API_URL}/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                }).catch(err => console.log('Logout API call failed:', err));
            } catch (e) {
                console.log('Could not perform API logout:', e);
            }
            
            // Redirect to login page
            window.location.href = 'login.html';
        }

        // Create a base64 placeholder image
        const placeholderImage = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 300'%3E%3Crect width='300' height='300' fill='%23f8f9fa'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%23adb5bd' font-size='24' font-family='Arial'%3EImage not found%3C/text%3E%3C/svg%3E";

        // Helper function to ensure image URL is valid
        function getSafeImageUrl(url) {
            if (!url) return placeholderImage;
            
            // Check if URL is absolute (starts with http or https)
            if (url.startsWith('http://') || url.startsWith('https://')) {
                return url;
            }
            
            // Check if URL starts with a slash
            if (url.startsWith('/')) {
                return url;
            }
            
            // If it's a relative path, make sure it's properly formatted
            let cleanUrl = url.replace(/^\.?\//, ''); // Remove leading ./ if present
            
            // Add 'images/' prefix if the URL doesn't already include a directory path
            if (!cleanUrl.includes('/') && !cleanUrl.startsWith('images/')) {
                console.log('Adding images/ prefix to image URL:', cleanUrl);
                cleanUrl = 'images/' + cleanUrl;
            }
            
            return cleanUrl;
        }

        // Render cart items from API or local storage
        async function renderCartItems() {
            console.log('==== Starting renderCartItems() ====');
            const cartContainer = document.getElementById('cart-items');
            
            if (!cartContainer) {
                console.error('Cart container element not found!');
                return;
            }
            
            try {
                // Clear loading spinner if present
                cartContainer.innerHTML = '';
                
                let items = [];
                let total = 0;
                let useLocalCart = false;
                
                // Try to get cart items from localStorage directly to diagnose any issues
                const rawLocalCartItems = localStorage.getItem('cartItems');
                console.log('Raw cartItems from localStorage:', rawLocalCartItems);
                
                // Parse local cart items if available
                let localItems = [];
                if (rawLocalCartItems) {
                    try {
                        localItems = JSON.parse(rawLocalCartItems);
                        console.log('Parsed local cart items:', localItems);
                    } catch (parseError) {
                        console.error('Error parsing local cart items:', parseError);
                    }
                }
                
                if (window.isAuthenticated()) {
                    console.log('User is authenticated, fetching cart from API');
                    console.log('Token:', localStorage.getItem('token'));
                    
                    // Fetch cart from API
                    try {
                        console.log('Calling getCart() function...');
                        const cart = await window.getCart();
                        console.log('Cart from API:', cart);
                        
                        // Ensure cart.items is an array
                        if (cart && Array.isArray(cart.items)) {
                            items = cart.items;
                            console.log('Got items array from cart:', items.length, 'items');
                            
                            // If server cart is empty but we have local items, offer to sync them
                            if (items.length === 0 && localItems && localItems.length > 0) {
                                console.log('Server cart is empty but local cart has items');
                                
                                // Show message asking user if they want to sync local cart
                                cartContainer.innerHTML = `
                                    <div class="empty-cart">
                                        <h2>Your account cart is empty, but we found ${localItems.length} item(s) in your local cart</h2>
                                        <p>Would you like to add these items to your account?</p>
                                        <button class="btn btn-primary" onclick="syncAndRenderCart()">Yes, Add to My Account</button>
                                        <button class="btn btn-secondary" onclick="clearLocalCartAndRender()">No, Clear Local Cart</button>
                                        <button class="btn btn-secondary" onclick="useLocalCartForNow()">Use Local Cart For Now</button>
                                    </div>
                                `;
                                return;
                            }
                        } else if (cart && cart.items) {
                            // Handle case where items might be an object not an array
                            console.log('Cart items not in expected format:', cart.items);
                            items = [];
                        } else {
                            console.log('No items found in cart, using empty array');
                            items = [];
                        }
                        
                        // Make sure total is a valid number
                        total = parseFloat(cart.total || 0);
                        if (isNaN(total)) total = 0;
                        console.log('Cart total:', total);
                        
                    } catch (apiError) {
                        console.error('API fetch error:', apiError);
                        // Fallback to local storage if API fails
                        console.log('Falling back to local storage due to API error');
                        useLocalCart = true;
                    }
                } else {
                    console.log('User is not authenticated, using local storage');
                    useLocalCart = true;
                }
                
                // Use local cart if needed
                if (useLocalCart) {
                    // Get items from local storage
                    try {
                        items = localItems;
                        console.log('Using local cart items:', items);
                        
                        // Calculate total using our dedicated function
                        total = calculateCartTotal(items);
                    } catch (calcError) {
                        console.error('Error processing local cart items:', calcError);
                        total = 0;
                    }
                }

                // Calculate total price
                // If total wasn't properly calculated above, calculate it manually
                if (total === 0 && items.length > 0) {
                    console.log('Re-calculating total from items array');
                    total = calculateCartTotal(items);
                }
                
                // Verify the total is a valid number
                if (isNaN(total)) {
                    console.error('Total is NaN, resetting to 0');
                    total = 0;
                }
                
                if (!items || !items.length) {
                    console.log('No items in cart, showing empty cart message');
                    cartContainer.innerHTML = `
                        <div class="empty-cart">
                            <h2>Your cart is empty</h2>
                            <p>Browse our shop to add items to your cart</p>
                            <a href="shop.html" class="btn btn-primary">Start Shopping</a>
                        </div>
                    `;
                    document.getElementById('total-price').textContent = '0.00';
                    return;
                }

                console.log('Rendering cart items:', items);
                try {
                    let cartHTML = '';
                    // Build the HTML for each item
                    items.forEach((item, index) => {
                        // Skip any null or undefined items
                        if (!item) {
                            console.log('Skipping null item at index', index);
                            return;
                        }
                        
                        console.log('Processing item:', item);
                        
                        // Extract item properties with fallbacks
                        const itemName = item.name || (item.product ? item.product.name : `Product #${item.productId || 'unknown'}`);
                        const itemImage = getSafeImageUrl(item.image || (item.product ? item.product.image : null)) || placeholderImage;
                        const itemPrice = parseFloat(item.price || (item.product ? item.product.price : 0)) || 0;
                        const itemId = item.id || item.productId || (item.product ? item.product.id : `local-${index}`);
                        const itemQuantity = parseInt(item.quantity) || 1;
                        
                        console.log('Extracted item details:', { 
                            name: itemName, 
                            price: itemPrice, 
                            id: itemId, 
                            quantity: itemQuantity,
                            image: itemImage
                        });
                        
                        cartHTML += `
                            <div class="cart-item">
                                <img src="${itemImage}" 
                                     alt="${itemName}" 
                                     onerror="this.onerror=null; this.src='${placeholderImage}';">
                                <div class="cart-item-details">
                                    <h3>${itemName}</h3>
                                    <p>â‚¹${itemPrice.toFixed(2)}</p>
                                    <div class="quantity-control">
                                        <label for="quantity-${index}" class="sr-only">Quantity</label>
                                        <button class="btn btn-secondary" 
                                                onclick="handleUpdateQuantity('${itemId}', ${itemQuantity - 1})"
                                                aria-label="Decrease quantity">-</button>
                                        <input type="number" id="quantity-${index}" 
                                               value="${itemQuantity}" min="1" max="10"
                                               onchange="handleUpdateQuantity('${itemId}', this.value)">
                                        <button class="btn btn-secondary" 
                                                onclick="handleUpdateQuantity('${itemId}', ${itemQuantity + 1})"
                                                aria-label="Increase quantity">+</button>
                                    </div>
                                </div>
                                <div class="cart-actions">
                                    <button class="btn btn-secondary" onclick="saveForLater('${itemId}')"
                                            aria-label="Save for later">
                                        <i class="fas fa-heart"></i> Save for Later
                                    </button>
                                    <button class="btn btn-secondary" onclick="handleRemoveItem('${itemId}')"
                                            aria-label="Remove from cart">
                                        Remove
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    console.log('Setting cart HTML');
                    cartContainer.innerHTML = cartHTML;
                } catch (renderError) {
                    console.error('Error rendering individual cart items:', renderError);
                    cartContainer.innerHTML = `
                        <div class="empty-cart">
                            <h2>Error rendering cart items</h2>
                            <p>There was a problem displaying your cart items</p>
                            <p>Error details: ${renderError.message}</p>
                            <button class="btn btn-primary" onclick="renderCartItems()">Try Again</button>
                            <button class="btn btn-secondary" onclick="resetAndRetryCart()">Reset Cart Data</button>
                        </div>
                    `;
                    return;
                }

                const totalElement = document.getElementById('total-price');
                if (totalElement) {
                    // Calculate the total using our dedicated function
                    const calculatedTotal = calculateCartTotal(items);
                    
                    // Format the total with 2 decimal places and display it
                    totalElement.textContent = calculatedTotal.toFixed(2);
                    console.log('Total price set to:', calculatedTotal.toFixed(2));
                } else {
                    console.error('Total price element not found!');
                }
                console.log('==== renderCartItems() completed successfully ====');
            } catch (error) {
                console.error('Error rendering cart:', error);
                cartContainer.innerHTML = `
                    <div class="empty-cart">
                        <h2>Error loading your cart</h2>
                        <p>There was a problem loading your cart items</p>
                        <p>Error details: ${error.message}</p>
                        <button class="btn btn-primary" onclick="renderCartItems()">Try Again</button>
                        <button class="btn btn-secondary" onclick="resetAndRetryCart()">Reset Cart Data</button>
                    </div>
                `;
            }
        }

        // Function to sync local cart items with server and re-render
        async function syncAndRenderCart() {
            try {
                console.log('Syncing local cart items to server cart');
                await checkForCartSync();
                renderCartItems();
            } catch (error) {
                console.error('Error syncing cart:', error);
                window.showToast('Error syncing cart: ' + error.message, 'error');
            }
        }

        // Function to clear local cart items and render server cart
        function clearLocalCartAndRender() {
            localStorage.removeItem('cartItems');
            window.showToast('Local cart cleared', 'info');
            renderCartItems();
        }

        // Function to use local cart items for now
        function useLocalCartForNow() {
            window.showToast('Using local cart for now', 'info');
            const localItems = JSON.parse(localStorage.getItem('cartItems') || '[]');
            
            if (localItems.length > 0) {
                // Force rendering local items
                window.getLocalCart = function() {
                    return localItems;
                };
            }
            
            renderCartItems();
        }

        // Function to reset cart data and retry loading
        function resetAndRetryCart() {
            try {
                // Clear local cart data
                localStorage.removeItem('cartItems');
                
                // Reset cart-related flags
                localStorage.removeItem('syncCart');
                
                // Show notification
                showToast('Cart data reset. Reloading cart...', 'info');
                
                // Reload cart after a short delay
                setTimeout(renderCartItems, 1000);
            } catch (error) {
                console.error('Error resetting cart:', error);
                showToast('Error resetting cart data', 'error');
            }
        }

        // Handler for updating item quantity
        async function handleUpdateQuantity(itemId, quantity) {
            try {
                // Ensure quantity is a number and within valid range
                quantity = parseInt(quantity);
                if (isNaN(quantity) || quantity < 1) {
                    quantity = 1;
                    console.log('Invalid quantity, defaulting to 1');
                }
                if (quantity > 10) {
                    quantity = 10;
                    console.log('Quantity capped at maximum of 10');
                }
                
                console.log(`Updating item ${itemId} quantity to ${quantity}`);
                
                if (window.isAuthenticated()) {
                    await window.updateCartItem(itemId, quantity);
                } else {
                    window.updateLocalCartItem(itemId, quantity);
                }
                
                // Re-render cart to update the UI
                renderCartItems();
            } catch (error) {
                console.error('Error updating quantity:', error);
                window.showToast('Error updating cart: ' + error.message, 'error');
            }
        }

        // Handler for removing an item
        async function handleRemoveItem(itemId) {
            if (window.isAuthenticated()) {
                await window.removeCartItem(itemId);
            } else {
                window.removeLocalCartItem(itemId);
            }
            
            renderCartItems();
        }

        // Handler for clearing the cart
        async function handleClearCart() {
            if (confirm('Are you sure you want to clear your cart?')) {
                if (window.isAuthenticated()) {
                    await window.clearCart();
                } else {
                    window.clearLocalCart();
                }
                
                renderCartItems();
            }
        }

        // Save for later function (wishlist)
        async function saveForLater(itemId) {
            try {
                console.log('Saving item for later:', itemId);
                
                // Find the item in the cart
                let item;
                
                if (window.isAuthenticated()) {
                    // Try to get from server cart
                    const serverCart = await window.getCart();
                    item = serverCart.items.find(cartItem => 
                        (cartItem.id && cartItem.id.toString() === itemId.toString()) || 
                        (cartItem.productId && cartItem.productId.toString() === itemId.toString())
                    );
                }
                
                // If not found or not authenticated, try local cart
                if (!item) {
                    const localCart = window.getLocalCart ? window.getLocalCart() : 
                                      JSON.parse(localStorage.getItem('cartItems') || '[]');
                    
                    item = localCart.find(cartItem => 
                        (cartItem.id && cartItem.id.toString() === itemId.toString()) || 
                        (cartItem.productId && cartItem.productId.toString() === itemId.toString())
                    );
                }
                
                if (!item) {
                    console.error('Item not found in cart:', itemId);
                    window.showToast('Item not found in cart', 'error');
                    return;
                }
                
                // Add to wishlist
                if (window.addToWishlist) {
                    await window.addToWishlist(
                        item.id || item.productId,
                        item.price,
                        item.name,
                        item.image,
                        item.description || ''
                    );
                    window.showToast(`${item.name} saved to wishlist`, 'success');
                } else {
                    // Fallback if addToWishlist function not available
                    const wishlistItems = JSON.parse(localStorage.getItem('wishlistItems') || '[]');
                    
                    // Check if already in wishlist
                    const existingItem = wishlistItems.find(wishItem => 
                        (wishItem.id && wishItem.id.toString() === (item.id || item.productId).toString()) || 
                        (wishItem.productId && wishItem.productId.toString() === (item.id || item.productId).toString())
                    );
                    
                    if (!existingItem) {
                        wishlistItems.push({
                            id: item.id || item.productId,
                            productId: item.id || item.productId,
                            name: item.name,
                            price: item.price,
                            image: item.image,
                            description: item.description || ''
                        });
                        
                        localStorage.setItem('wishlistItems', JSON.stringify(wishlistItems));
                        window.showToast(`${item.name} saved to wishlist`, 'success');
                    } else {
                        window.showToast(`${item.name} is already in your wishlist`, 'info');
                    }
                }
                
                // Ask if user wants to remove the item from cart
                if (confirm(`Remove ${item.name} from cart after saving to wishlist?`)) {
                    if (window.isAuthenticated()) {
                        await window.removeCartItem(itemId);
                    } else {
                        window.removeLocalCartItem(itemId);
                    }
                    renderCartItems();
                }
            } catch (error) {
                console.error('Error saving item for later:', error);
                window.showToast('Error saving item to wishlist', 'error');
            }
        }

        // Proceed to checkout
        function proceedToCheckout() {
            // Check if cart is empty
            if (document.getElementById('cart-items').querySelector('.empty-cart')) {
                window.showToast('Your cart is empty', 'warning');
                return;
            }
            
            // Check if user is authenticated
            if (!window.isAuthenticated()) {
                // Redirect to login if not authenticated
                localStorage.setItem('checkoutRedirect', true);
                window.location.href = 'login.html?redirect=checkout';
                return;
            }
            
            // Try to use the cart.js prepareCartForCheckout function if available
            if (typeof window.prepareCartForCheckout === 'function') {
                window.prepareCartForCheckout()
                    .then(result => {
                        console.log('Cart prepared for checkout:', result);
                        // Redirect to checkout page
                        window.location.href = 'checkout.html';
                    })
                    .catch(error => {
                        console.error('Error preparing cart for checkout:', error);
                        window.showToast('Error preparing your cart for checkout', 'error');
                    });
            } else {
                // Fallback to our own implementation
                // Get current cart items
                let cartItems = [];
                
                try {
                    // First try to get cart items from the cart.js getCart function
                    if (typeof window.getCart === 'function') {
                        cartItems = window.getCart().items || [];
                    } 
                    // If no items or function doesn't exist, try to get from local cart
                    if (cartItems.length === 0 && typeof window.getLocalCart === 'function') {
                        cartItems = window.getLocalCart();
                    }
                    // If still no items, try direct localStorage access
                    if (cartItems.length === 0) {
                        cartItems = JSON.parse(localStorage.getItem('cartItems') || '[]');
                    }
                    
                    // Log what we found
                    console.log('Proceeding to checkout with', cartItems.length, 'cart items');
                    
                    // If we have cart items, make sure they're saved in localStorage
                    if (cartItems.length > 0) {
                        localStorage.setItem('cartItems', JSON.stringify(cartItems));
                        
                        // Also save total price
                        const totalPrice = document.getElementById('total-price').textContent;
                        localStorage.setItem('totalAmount', totalPrice);
                        
                        console.log('Saved cart items and total price to localStorage');
                    } else {
                        window.showToast('Your cart appears to be empty', 'warning');
                        return;
                    }
                } catch (error) {
                    console.error('Error preparing cart for checkout:', error);
                    window.showToast('Error preparing your cart for checkout', 'error');
                    return;
                }
                
                // All good, proceed to checkout
                window.location.href = 'checkout.html';
            }
        }

        // Check if user just logged in and needs to sync cart
        async function checkForCartSync() {
            console.log('Checking for cart sync requirements...');
            
            // Check if user is logged in
            if (!window.isAuthenticated()) {
                console.log('User not authenticated, no sync needed');
                return;
            }
            
            // Check if there are items in localStorage
            const localCartItems = localStorage.getItem('cartItems');
            if (!localCartItems) {
                console.log('No local cart items to sync');
                return;
            }
            
            try {
                // Parse local cart items
                const parsedItems = JSON.parse(localCartItems);
                if (!Array.isArray(parsedItems) || parsedItems.length === 0) {
                    console.log('No valid items in local cart to sync');
                    return;
                }
                
                console.log('Found', parsedItems.length, 'local items to sync with server');
                
                // Sync items with server
                if (typeof window.syncCartWithServer === 'function') {
                    console.log('Starting cart sync process...');
                    try {
                        await window.syncCartWithServer();
                        window.showToast('Your cart has been synchronized with your account', 'success');
                    } catch (syncError) {
                        console.error('Error syncing cart:', syncError);
                        
                        // Manual sync as fallback
                        console.log('Attempting manual sync as fallback...');
                        let syncSuccess = false;
                        
                        for (const item of parsedItems) {
                            try {
                                await window.addToCart(
                                    item.id || item.productId, 
                                    item.quantity || 1, 
                                    item.price, 
                                    item.name, 
                                    item.image
                                );
                                syncSuccess = true;
                            } catch (itemError) {
                                console.error('Error syncing item:', item, itemError);
                            }
                        }
                        
                        if (syncSuccess) {
                            // Clear local cart after successful sync
                            localStorage.removeItem('cartItems');
                            window.showToast('Your cart has been synchronized with your account', 'success');
                        }
                    }
                } else {
                    console.log('SyncCartWithServer function not available, using manual sync');
                    // Manual sync process
                    for (const item of parsedItems) {
                        try {
                            await window.addToCart(
                                item.id || item.productId, 
                                item.quantity || 1, 
                                item.price, 
                                item.name, 
                                item.image
                            );
                        } catch (itemError) {
                            console.error('Error syncing item:', item, itemError);
                        }
                    }
                    
                    // Clear local cart after sync
                    localStorage.removeItem('cartItems');
                    window.showToast('Your cart has been synchronized with your account', 'success');
                }
                
                console.log('Cart sync process completed');
            } catch (error) {
                console.error('Error in cart sync process:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Update auth section first
            updateAuthSection();
            
            // Then check for cart sync and perform sync if needed
            await checkForCartSync();
            
            // Finally render cart items
            await renderCartItems();
        });

        // Add fallback functions in case cart.js fails to load
        // Function to check if user is authenticated
        if (typeof window.isAuthenticated !== 'function') {
            // Only define the function if it doesn't already exist
            window.isAuthenticated = function() {
                return localStorage.getItem('token') !== null;
            };
        }

        // Fallback function to get local cart
        if (typeof window.getLocalCart !== 'function') {
            // Only define the function if it doesn't already exist
            window.getLocalCart = function() {
                try {
                    return JSON.parse(localStorage.getItem('cartItems')) || [];
                } catch (error) {
                    console.error('Error loading local cart:', error);
                    return [];
                }
            };
        }

        // Helper function to show toast messages if not defined in cart.js
        if (typeof window.showToast !== 'function') {
            // Only define the function if it doesn't already exist
            window.showToast = function(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            };
        }

        // Fallback for cart operations
        if (typeof window.updateCartItem !== 'function') {
            window.updateCartItem = function(itemId, quantity) {
                try {
                    const cart = window.getLocalCart();
                    // Find the item by either id or productId and convert both to strings for comparison
                    const itemIndex = cart.findIndex(item => 
                        (item.id && item.id.toString() === itemId.toString()) || 
                        (item.productId && item.productId.toString() === itemId.toString())
                    );
                    
                    if (itemIndex !== -1) {
                        cart[itemIndex].quantity = parseInt(quantity);
                        localStorage.setItem('cartItems', JSON.stringify(cart));
                        window.showToast('Cart updated', 'success');
                    } else {
                        console.error('Item not found in cart:', itemId);
                        window.showToast('Item not found in cart', 'error');
                    }
                } catch (error) {
                    console.error('Error updating local cart item:', error);
                    window.showToast('Error updating cart', 'error');
                }
            };
        }

        if (typeof window.removeCartItem !== 'function') {
            window.removeCartItem = function(itemId) {
                try {
                    let cart = window.getLocalCart();
                    // Check if the item exists before removing
                    const itemExists = cart.some(item => 
                        (item.id && item.id.toString() === itemId.toString()) || 
                        (item.productId && item.productId.toString() === itemId.toString())
                    );
                    
                    if (itemExists) {
                        // Filter out the item with the matching id or productId
                        cart = cart.filter(item => 
                            !(item.id && item.id.toString() === itemId.toString()) && 
                            !(item.productId && item.productId.toString() === itemId.toString())
                        );
                        localStorage.setItem('cartItems', JSON.stringify(cart));
                        window.showToast('Item removed from cart', 'success');
                    } else {
                        console.error('Item not found for removal:', itemId);
                        window.showToast('Item not found in cart', 'error');
                    }
                } catch (error) {
                    console.error('Error removing from local cart:', error);
                    window.showToast('Error removing item', 'error');
                }
            };
        }

        if (typeof window.clearCart !== 'function') {
            window.clearCart = function() {
                try {
                    localStorage.setItem('cartItems', JSON.stringify([]));
                    window.showToast('Cart cleared', 'success');
                } catch (error) {
                    console.error('Error clearing local cart:', error);
                    window.showToast('Error clearing cart', 'error');
                }
            };
        }

        if (typeof window.syncCartWithServer !== 'function') {
            window.syncCartWithServer = function() {
                return Promise.resolve();
            };
        }

        // Fallback getCart function
        if (typeof window.getCart !== 'function') {
            window.getCart = async function() {
                try {
                    const API_URL = 'http://localhost:3000/api';
                    console.log('Fallback getCart: Fetching cart from API...');
                    
                    const response = await fetch(`${API_URL}/cart`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    console.log('Fallback getCart: API Response status:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`Failed to fetch cart: ${response.status} ${response.statusText}`);
                    }
                    
                    const cart = await response.json();
                    console.log('Fallback getCart: Cart data received:', cart);
                    return cart;
                } catch (error) {
                    console.error('Fallback getCart: Error fetching cart:', error);
                    
                    // Fall back to local storage
                    const items = window.getLocalCart();
                    
                    // Calculate total using our dedicated function
                    const total = calculateCartTotal(items);
                    
                    return {
                        items: items,
                        total: total
                    };
                }
            };
        }

        if (typeof window.updateLocalCartItem !== 'function') {
            window.updateLocalCartItem = function(itemId, quantity) {
                return window.updateCartItem(itemId, quantity);
            };
        }

        if (typeof window.removeLocalCartItem !== 'function') {
            window.removeLocalCartItem = function(itemId) {
                return window.removeCartItem(itemId);
            };
        }

        if (typeof window.clearLocalCart !== 'function') {
            window.clearLocalCart = function() {
                return window.clearCart();
            };
        }

        // Debug cart function to help troubleshoot cart issues
        function debugCart() {
            console.log('==== Cart Debug Information ====');
            
            // Get cart items from localStorage directly
            const rawLocalCartItems = localStorage.getItem('cartItems');
            console.log('Raw cartItems from localStorage:', rawLocalCartItems);
            
            // Try to parse the cart items
            try {
                const parsedItems = JSON.parse(rawLocalCartItems || '[]');
                console.log('Parsed cart items:', parsedItems);
                
                // Display the cart items in an alert for the user
                alert(`Cart Debug Info: ${parsedItems.length} items in cart.\nCheck console for details.`);
                
                // Add cart items to DOM for inspection
                const cartItems = window.getLocalCart();
                console.log('Cart items from getLocalCart():', cartItems);
                
                // Create a dummy cart in localStorage with test products if cart is empty
                if (cartItems.length === 0) {
                    console.log('Creating test cart items');
                    const testItems = [
                        {
                            id: 'test-1',
                            productId: 1,
                            name: 'Test Product 1',
                            price: 199,
                            quantity: 1, 
                            image: 'images/toothbrush.jpeg'
                        },
                        {
                            id: 'test-2',
                            productId: 2,
                            name: 'Test Product 2',
                            price: 299,
                            quantity: 2,
                            image: 'images/loofah.webp'
                        }
                    ];
                    
                    localStorage.setItem('cartItems', JSON.stringify(testItems));
                    console.log('Test cart items created, refresh the page to see them');
                    alert('Test cart items created. Please refresh the page to see them.');
                }
                
            } catch (error) {
                console.error('Error parsing cart items:', error);
                alert(`Error: ${error.message}.\nClearing cart data and creating test data.`);
                
                // Create test data
                const testItems = [
                    {
                        id: 'test-1',
                        productId: 1,
                        name: 'Test Product 1',
                        price: 199,
                        quantity: 1, 
                        image: 'images/toothbrush.jpeg'
                    }
                ];
                
                localStorage.setItem('cartItems', JSON.stringify(testItems));
                console.log('Test cart items created, refresh the page to see them');
                alert('Test cart items created. Please refresh the page to see them.');
            }
        }

        // Add a dedicated function to calculate the total price
        function calculateCartTotal(items) {
            console.log('Calculating total for', items.length, 'items');
            
            try {
                let total = 0;
                
                // Loop through each item and add its subtotal to the total
                items.forEach(item => {
                    const price = parseFloat(item.price || 0);
                    const quantity = parseInt(item.quantity || 1);
                    const itemTotal = price * quantity;
                    
                    console.log(`Item: ${item.name}, Price: ${price}, Quantity: ${quantity}, Subtotal: ${itemTotal}`);
                    total += itemTotal;
                });
                
                console.log('Total calculated:', total);
                return total;
            } catch (error) {
                console.error('Error calculating cart total:', error);
                return 0;
            }
        }
    </script>
</body>
</html>
